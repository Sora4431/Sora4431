name: Update Profile with Market Data

on:
  schedule:
    - cron: "0 8 * * *" # 17:00 JST
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-profile:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout profile repository
        uses: actions/checkout@v4
        with:
          repository: Sora4431/Sora4431
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout market-data repository
        uses: actions/checkout@v4
        with:
          repository: Sora4431/market-data
          path: market-data

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install pandas matplotlib

      - name: Generate market chart
        run: |
          cd market-data
          python plot_market_chart.py
          cd ..

      - name: Update README with market data and charts
        run: |
          cat > update_readme.py << 'PYTHON_SCRIPT'
          import pandas as pd
          import re

          # CSVã‹ã‚‰æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
          df = pd.read_csv('market-data/market_data.csv')
          latest = df.iloc[-1]

          date = latest['date']

          # æœ€æ–°ã®ä¾¡æ ¼ã¨å¤‰åŒ–
          nikkei = f"Â¥{latest['nikkei_225']:,.2f}"
          nikkei_change = latest['nikkei_change']
          nikkei_pct = latest['nikkei_pct']
          nikkei_arrow = "ğŸ“ˆ" if nikkei_change >= 0 else "ğŸ“‰"

          sp500 = f"${latest['sp500']:,.2f}"
          sp500_change = latest['sp500_change']
          sp500_pct = latest['sp500_pct']
          sp500_arrow = "ğŸ“ˆ" if sp500_change >= 0 else "ğŸ“‰"

          gold = f"Â¥{latest['gold_jpy']:,.2f}/oz"
          gold_change = latest['gold_change']
          gold_pct = latest['gold_pct']
          gold_arrow = "ğŸ“ˆ" if gold_change >= 0 else "ğŸ“‰"

          # README.mdã‚’èª­ã¿è¾¼ã¿
          with open('README.md', 'r') as f:
              content = f.read()

          # ãƒãƒ¼ã‚±ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°
          # ç”Ÿæˆã•ã‚ŒãŸSVGãƒãƒ£ãƒ¼ãƒˆã¸ã®ãƒªãƒ³ã‚¯ã‚’ä½¿ç”¨
          chart_nikkei_url = "https://raw.githubusercontent.com/Sora4431/market-data/main/chart_nikkei.svg"
          chart_sp500_url = "https://raw.githubusercontent.com/Sora4431/market-data/main/chart_sp500.svg"
          chart_gold_url = "https://raw.githubusercontent.com/Sora4431/market-data/main/chart_gold.svg"

          new_section = f"""<!--START_MARKET_DATA-->
          | Market | Price | Change | Date |
          |--------|-------|--------|------|
          | ğŸ“ˆ **Nikkei 225** | {nikkei} | {nikkei_arrow} {nikkei_change:+.2f} ({nikkei_pct:+.2f}%) | {date} |
          | ğŸ‡ºğŸ‡¸ **S&P 500** | {sp500} | {sp500_arrow} {sp500_change:+.2f} ({sp500_pct:+.2f}%) | {date} |
          | ğŸ¥‡ **Gold** | {gold} | {gold_arrow} {gold_change:+.2f} ({gold_pct:+.2f}%) | {date} |

          ### ğŸ“Š 14-Day Market Trends (Indexed)

          ![Nikkei 225 Trends]({chart_nikkei_url})

          ![S&P 500 Trends]({chart_sp500_url})

          ![Gold Trends]({chart_gold_url})

          <!--END_MARKET_DATA-->"""

          # ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç½®æ›
          pattern = r'<!--START_MARKET_DATA-->.*?<!--END_MARKET_DATA-->'
          content = re.sub(pattern, new_section, content, flags=re.DOTALL)

          # README.mdã‚’ä¿å­˜
          with open('README.md', 'w') as f:
              f.write(content)

          print(f"Updated market data for {date}")
          PYTHON_SCRIPT

          python update_readme.py

      - name: Commit and push changes
        run: |
          git config user.name "Sora4431"
          git config user.email "Sora4431@users.noreply.github.com"
          git add README.md
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "ğŸ“Š Update market data with charts"
            git push
          fi
