name: Update Profile with Market Data

on:
  schedule:
    - cron: "0 23 * * 1-5" # 23:00 UTC, 1 hour after market-data updates at 22:00 UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-profile:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout profile repository
        uses: actions/checkout@v4
        with:
          repository: Sora4431/Sora4431
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout market-data repository
        uses: actions/checkout@v4
        with:
          repository: Sora4431/market-data
          path: market-data

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install pandas

      - name: Update README with market data and charts
        run: |
          cat > update_readme.py << 'PYTHON_SCRIPT'
          import pandas as pd
          import re

          df = pd.read_csv('market-data/market_data.csv')

          # Use last actual trading day (market_open=1 if column exists)
          if 'market_open' in df.columns:
              latest = df[df['market_open'] == 1].iloc[-1]
          else:
              latest = df.iloc[-1]

          date = latest['date']

          sp500       = f"${latest['sp500']:,.2f}"
          sp500_ch    = latest['sp500_change']
          sp500_pct   = latest['sp500_pct']
          sp500_arrow = "ğŸ“ˆ" if sp500_ch >= 0 else "ğŸ“‰"

          wti         = f"${latest['wti']:,.2f}/bbl"
          wti_ch      = latest['wti_change']
          wti_pct     = latest['wti_pct']
          wti_arrow   = "ğŸ“ˆ" if wti_ch >= 0 else "ğŸ“‰"

          us10y       = f"{latest['us10y']:.4f}%"
          us10y_ch    = latest['us10y_change']
          us10y_pct   = latest['us10y_pct']
          us10y_arrow = "ğŸ“ˆ" if us10y_ch >= 0 else "ğŸ“‰"

          chart_sp500_url = "https://raw.githubusercontent.com/Sora4431/market-data/main/chart_sp500.svg"
          chart_wti_url   = "https://raw.githubusercontent.com/Sora4431/market-data/main/chart_wti.svg"
          chart_us10y_url = "https://raw.githubusercontent.com/Sora4431/market-data/main/chart_us10y.svg"

          new_section = f"""<!--START_MARKET_DATA-->
          | Market | Price | Change | Date |
          |--------|-------|--------|------|
          | ğŸ‡ºğŸ‡¸ **S&P 500** | {sp500} | {sp500_arrow} {sp500_ch:+.2f} ({sp500_pct:+.2f}%) | {date} |
          | ğŸ›¢ï¸ **WTI Crude** | {wti} | {wti_arrow} {wti_ch:+.2f} ({wti_pct:+.2f}%) | {date} |
          | ğŸ¦ **US 10Y Yield** | {us10y} | {us10y_arrow} {us10y_ch:+.4f} ({us10y_pct:+.2f}%) | {date} |

          ### ğŸ“Š 14-Day Market Trends

          ![S&P 500]({chart_sp500_url})

          ![WTI Crude Oil]({chart_wti_url})

          ![US 10-Year Treasury Yield]({chart_us10y_url})

          <!--END_MARKET_DATA-->"""

          with open('README.md', 'r') as f:
              content = f.read()

          pattern = r'<!--START_MARKET_DATA-->.*?<!--END_MARKET_DATA-->'
          content = re.sub(pattern, new_section, content, flags=re.DOTALL)

          with open('README.md', 'w') as f:
              f.write(content)

          print(f"Updated market data for {date}")
          PYTHON_SCRIPT

          python update_readme.py

      - name: Commit and push changes
        run: |
          git config user.name "Sora4431"
          git config user.email "Sora4431@users.noreply.github.com"
          git add README.md
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "ğŸ“Š Update market data with charts"
            git push
          fi
