name: Update Profile with Market Data

on:
  schedule:
    - cron: "0 8 * * *" # 17:00 JST (ãƒ‡ãƒ¼ã‚¿å–å¾—å¾Œ)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-profile:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout profile repository
        uses: actions/checkout@v4
        with:
          repository: Sora4431/Sora4431
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Checkout market-data repository
        uses: actions/checkout@v4
        with:
          repository: Sora4431/market-data
          path: market-data
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Install dependencies
        run: pip install pandas
      
      - name: Update README with market data
        run: |
          cat > update_readme.py << 'PYTHON_SCRIPT'
          import pandas as pd
          import re
          
          # CSVã‹ã‚‰æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
          df = pd.read_csv('market-data/market_data.csv')
          latest = df.iloc[-1]
          
          date = latest['date']
          nikkei = f"Â¥{latest['nikkei_225']:,.2f}"
          sp500 = f"${latest['sp500']:,.2f}"
          gold = f"${latest['gold_usd']:,.2f}/oz"
          
          # README.mdã‚’èª­ã¿è¾¼ã¿
          with open('README.md', 'r') as f:
              content = f.read()
          
          # ãƒãƒ¼ã‚±ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°
          new_table = f"""
          <!--START_MARKET_DATA-->
          | Market | Price | Date |   
          |--------|-------|------|
          | ğŸ“ˆ **Nikkei 225** | {nikkei} | {date} |
          | ğŸ‡ºğŸ‡¸ **S&P 500** | {sp500} | {date} |
          | ğŸ¥‡ **Gold** | {gold} | {date} |
          <!--END_MARKET_DATA-->"""
          
          # ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç½®æ›
          pattern = r'<!--START_MARKET_DATA-->.*?<!--END_MARKET_DATA-->'
          content = re.sub(pattern, new_table, content, flags=re.DOTALL)
          
          # README.mdã‚’ä¿å­˜
          with open('README.md', 'w') as f:
              f.write(content)
          
          print(f"Updated market data for {date}")
          PYTHON_SCRIPT
          
          python update_readme.py
      
      - name: Commit and push changes
        run: |
          git config user.name "Sora4431"
          git config user.email "Sora4431@users.noreply.github.com"
          git add README.md
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "ğŸ“Š Update market data: Nikkei, S&P 500, Gold"
            git push
          fi
